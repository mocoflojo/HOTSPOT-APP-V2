{% extends 'base.html' %}

{% block title %}Editor de Plantillas{% endblock %}

{% block page_title %}Editor de Plantilla de Vouchers{% endblock %}

<style>
    /* Estilos b√°sicos para el textarea como editor de c√≥digo */
    .template-editor-textarea {
        font-family: monospace;
        background-color: #282c34;
        color: #abb2bf;
        padding: 10px;
        border: 1px solid #5c6370;
        border-radius: 5px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box; /* Para que el padding no aumente el ancho total */
        min-height: 400px; /* Altura m√≠nima */
    }
</style>

{% block content %}
<div class="card bg-white rounded-lg p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-blue-600">‚úçÔ∏è Edita tu Plantilla de Voucher</h2>
    <p class="mb-4 text-gray-700">Aqu√≠ puedes modificar el dise√±o HTML de los vouchers. Recuerda usar las variables de Jinja2 como <code>{% raw %}{{ voucher.username }}{% endraw %}</code>, <code>{% raw %}{{ voucher.price }}{% endraw %}</code>, etc. Un HTML incorrecto puede romper la p√°gina de impresi√≥n.</p>

    {% if saved_message %}
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
        <p class="font-bold">¬°√âxito!</p>
        <p>{{ saved_message }}</p>
    </div>
    {% endif %}

    <form id="templateEditorForm" method="POST" action="{{ url_for('main.voucher_template_editor') }}" class="space-y-4">
        <div>
            <label for="template_code" class="block text-sm font-medium text-gray-700">C√≥digo HTML de la Plantilla:</label>
            <textarea name="template_code" id="template_code" rows="25" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3 font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 template-editor-textarea">{{ current_template_content }}</textarea>
            <p class="mt-1 text-xs text-gray-500">Variables disponibles: <code>{% raw %}{{ voucher.username }}{% endraw %}</code>, <code>{% raw %}{{ voucher.password }}{% endraw %}</code>, <code>{% raw %}{{ voucher.limit_uptime_formatted }}{% endraw %}</code>, <code>{% raw %}{{ voucher.expiration_mode_display }}{% endraw %}</code>, <code>{% raw %}{{ voucher.price }}{% endraw %}</code>, <code>{% raw %}{{ hotspot_dns }}{% endraw %}</code>, <code>{% raw %}{{ voucher.mode }}{% endraw %}</code>.</p>
        </div>
        <div class="pt-2 flex space-x-4">
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-save mr-2"></i>Guardar Plantilla
            </button>
            <button type="button" onclick="previewTemplate()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-eye mr-2"></i>Previsualizar
            </button>
        </div>
    </form>

    <div id="previewArea" class="mt-8 p-4 border border-blue-300 bg-blue-50 rounded-lg hidden">
        <h3 class="text-lg font-semibold mb-2">Previsualizaci√≥n del Voucher:</h3>
        <div id="previewContent" class="overflow-auto" style="max-height: 400px; background-color: white; padding: 10px; border-radius: 5px;">
            </div>
    </div>

    <div class="card bg-white rounded-lg p-6 mt-8">
        <h2 class="text-lg font-semibold mb-4 text-blue-600">üñºÔ∏è Subir Logo para Vouchers</h2>
        <p class="mb-4 text-gray-700">Sube un archivo de imagen (PNG, JPG) para usarlo como logo en tus vouchers. Se recomienda un logo cuadrado de alta resoluci√≥n.</p>

        {% if upload_logo_message %}
        <div class="mb-4 {% if 'exitosamente' in upload_logo_message %}bg-green-100 border-l-4 border-green-500 text-green-700{% else %}bg-red-100 border-l-4 border-red-500 text-red-700{% endif %} p-4" role="alert">
            <p class="font-bold">{% if 'exitosamente' in upload_logo_message %}¬°√âxito!{% else %}¬°Error!{% endif %}</p>
            <p>{{ upload_logo_message }}</p>
        </div>
        {% endif %}

        <form id="logoUploadForm" method="POST" action="{{ url_for('main.upload_logo') }}" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label for="logo_file" class="block text-sm font-medium text-gray-700">Seleccionar archivo de imagen:</label>
                <input type="file" name="logo_file" id="logo_file" accept="image/png, image/jpeg, image/jpg" class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                <p class="mt-1 text-xs text-gray-500">Solo archivos .png, .jpg, .jpeg son aceptados. Se guardar√° como "logo.png".</p>
            </div>
            <div class="pt-2">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-upload mr-2"></i>Subir Logo
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    async function previewTemplate() {
        const templateCode = document.getElementById('template_code').value;
        const previewArea = document.getElementById('previewArea');
        const previewContent = document.getElementById('previewContent');

        previewArea.classList.remove('hidden');
        previewContent.innerHTML = '<div class="text-center text-gray-500">Cargando previsualizaci√≥n...</div>';

        try {
            const response = await fetch("{{ url_for('main.preview_voucher_template') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `template_code=${encodeURIComponent(templateCode)}`
            });

            if (response.ok) {
                const html = await response.text();
                previewContent.innerHTML = html;
            } else {
                const errorText = await response.text();
                previewContent.innerHTML = `<div style="color: red;">Error al previsualizar: <br>${errorText}</div>`;
            }
        } catch (error) {
            previewContent.innerHTML = `<div style="color: red;">Error de red o JS: ${error}</div>`;
        }
    }
</script>
{% endblock %}