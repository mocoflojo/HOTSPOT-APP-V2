{% extends 'base.html' %}

{% block title %}Editor de Plantillas{% endblock %}

{% block page_title %}Editor de Plantilla de Vouchers{% endblock %}

{% block content %}
<div class="card bg-white rounded-lg p-6 mb-8">
    <h2 class="text-lg font-semibold mb-4 text-blue-600">‚úçÔ∏è Editor de Plantillas de Vouchers</h2>

    <!-- Selector de Plantilla con Botones Visuales -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-3">Selecciona la plantilla a editar:</label>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            {% for key, template in voucher_templates.items() %}
            <button type="button" onclick="changeTemplate('{{ key }}')" class="template-selector-btn p-3 border-2 rounded-lg transition-all duration-200 text-left
                               {% if key == selected_template %}
                                   border-blue-500 bg-blue-50
                               {% else %}
                                   border-gray-300 bg-white hover:border-blue-300
                               {% endif %}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        {% if key == 'standard' %}
                        <i class="fas fa-image text-blue-500 text-lg mr-3"></i>
                        {% elif key == 'compact' %}
                        <i class="fas fa-file-alt text-green-500 text-lg mr-3"></i>
                        {% else %}
                        <i class="fas fa-receipt text-purple-500 text-lg mr-3"></i>
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900 text-sm">{{ template.name }}</h3>
                            <p class="text-xs text-gray-500">{{ template.description }}</p>
                        </div>
                    </div>
                    {% if key == selected_template %}
                    <i class="fas fa-check-circle text-blue-500 ml-2"></i>
                    {% endif %}
                </div>
            </button>
            {% endfor %}
        </div>
        <p class="mt-3 text-xs text-gray-500">
            <i class="fas fa-info-circle mr-1"></i>
            Cada plantilla se guarda por separado. Puedes editar las 3 independientemente.
        </p>
    </div>

    <p class="mb-4 text-gray-700">Aqu√≠ puedes modificar el dise√±o HTML de los vouchers. Recuerda usar las variables de
        Jinja2 como <code>{% raw %}{{ voucher.username }}{% endraw %}</code>,
        <code>{% raw %}{{ voucher.price }}{% endraw %}</code>, etc. Un HTML incorrecto puede romper la p√°gina de
        impresi√≥n.
    </p>

    {% if saved_message %}
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
        <p class="font-bold">¬°√âxito!</p>
        <p>{{ saved_message }}</p>
    </div>
    {% endif %}

    <form id="templateEditorForm" method="POST" action="{{ url_for('main.voucher_template_editor') }}"
        class="space-y-4">

        <!-- Campo oculto para saber qu√© plantilla se est√° guardando -->
        <input type="hidden" name="template_type" id="template_type" value="{{ selected_template }}">

        <div>
            <label for="monaco-container" class="block text-sm font-medium text-gray-700 mb-2">C√≥digo HTML de la
                Plantilla (Editor VS Code):</label>

            <!-- Contenedor para Monaco Editor -->
            <div id="monaco-container" style="width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <!-- Textarea oculto para enviar los datos en el formulario -->
            <textarea name="template_code" id="template_code"
                style="display: none;">{{ current_template_content }}</textarea>

            <p class="mt-2 text-xs text-gray-500">Variables disponibles:
                <code>{% raw %}{{ voucher.number }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.username }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.password }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.limit_uptime_formatted }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.expiration_mode_display }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.price }}{% endraw %}</code>,
                <code>{% raw %}{{ hotspot_dns }}{% endraw %}</code>,
                <code>{% raw %}{{ voucher.mode }}{% endraw %}</code>.
            </p>
        </div>
        <div class="pt-2 flex space-x-4">
            <button type="submit"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-save mr-2"></i>Guardar Plantilla
            </button>
            <button type="button" onclick="previewTemplate()"
                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-eye mr-2"></i>Previsualizar
            </button>
        </div>
    </form>

    <div id="previewArea" class="mt-8 p-4 border border-blue-300 bg-blue-50 rounded-lg hidden">
        <h3 class="text-lg font-semibold mb-2">Previsualizaci√≥n del Voucher:</h3>
        <div id="previewContent" class="overflow-auto"
            style="max-height: 400px; background-color: white; padding: 10px; border-radius: 5px;">
        </div>
    </div>

    <div class="card bg-white rounded-lg p-6 mt-8">
        <h2 class="text-lg font-semibold mb-4 text-blue-600">üñºÔ∏è Subir Logo para Vouchers</h2>
        <p class="mb-4 text-gray-700">Sube un archivo de imagen (PNG, JPG) para usarlo como logo en tus vouchers. Se
            recomienda un logo cuadrado de alta resoluci√≥n.</p>

        {% if upload_logo_message %}
        <div class="mb-4 {% if 'exitosamente' in upload_logo_message %}bg-green-100 border-l-4 border-green-500 text-green-700{% else %}bg-red-100 border-l-4 border-red-500 text-red-700{% endif %} p-4"
            role="alert">
            <p class="font-bold">{% if 'exitosamente' in upload_logo_message %}¬°√âxito!{% else %}¬°Error!{% endif %}</p>
            <p>{{ upload_logo_message }}</p>
        </div>
        {% endif %}

        <form id="logoUploadForm" method="POST" action="{{ url_for('main.upload_logo') }}" enctype="multipart/form-data"
            class="space-y-4">
            <div>
                <label for="logo_file" class="block text-sm font-medium text-gray-700">Seleccionar archivo de
                    imagen:</label>
                <input type="file" name="logo_file" id="logo_file" accept="image/png, image/jpeg, image/jpg"
                    class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                <p class="mt-1 text-xs text-gray-500">Solo archivos .png, .jpg, .jpeg son aceptados. Se guardar√° como
                    "logo.png".</p>
            </div>
            <div class="pt-2">
                <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-upload mr-2"></i>Subir Logo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Cargar Monaco Editor desde CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
    let editor; // Variable global para la instancia del editor

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
        // Obtener el contenido inicial del textarea oculto
        var initialContent = document.getElementById('template_code').value;

        editor = monaco.editor.create(document.getElementById('monaco-container'), {
            value: initialContent,
            language: 'html',
            theme: 'vs-dark', // Tema oscuro tipo VS Code
            automaticLayout: true,
            minimap: {
                enabled: true
            },
            fontSize: 14,
            scrollBeyondLastLine: false,
            wordWrap: 'on'
        });

        // Sincronizar el contenido del editor con el textarea oculto antes de enviar el formulario
        document.getElementById('templateEditorForm').addEventListener('submit', function () {
            document.getElementById('template_code').value = editor.getValue();
        });
    });

    // Funci√≥n para cambiar de plantilla
    function changeTemplate(templateKey) {
        // Redirigir a la misma p√°gina pero con el par√°metro de la plantilla seleccionada
        window.location.href = "{{ url_for('main.voucher_template_editor') }}?template=" + templateKey;
    }

    async function previewTemplate() {
        // Obtener el c√≥digo directamente del editor Monaco si est√° inicializado, sino del textarea
        let templateCode = "";
        if (editor) {
            templateCode = editor.getValue();
        } else {
            templateCode = document.getElementById('template_code').value;
        }

        const previewArea = document.getElementById('previewArea');
        const previewContent = document.getElementById('previewContent');

        previewArea.classList.remove('hidden');
        previewContent.innerHTML = '<div class="text-center text-gray-500">Cargando previsualizaci√≥n...</div>';

        try {
            const response = await fetch("{{ url_for('main.preview_voucher_template') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `template_code=${encodeURIComponent(templateCode)}`
            });

            if (response.ok) {
                const html = await response.text();
                previewContent.innerHTML = html;
            } else {
                const errorText = await response.text();
                previewContent.innerHTML = `<div style="color: red;">Error al previsualizar: <br>${errorText}</div>`;
            }
        } catch (error) {
            previewContent.innerHTML = `<div style="color: red;">Error de red o JS: ${error}</div>`;
        }
    }
</script>
{% endblock %}